Genial, esto ya est√° en modo ‚Äúentregable para el equipo‚Äù üßë‚Äçüíªüßë‚Äç‚öïÔ∏è

Te voy a dejar una **documentaci√≥n en formato Markdown** que puedes pegar tal cual en Notion, un repo, etc. Est√° pensada para que el frontend:

* Entienda **c√≥mo pensar el backend**.
* Sepa **qu√© endpoints hay**, qu√© env√≠an y qu√© reciben.
* Comprenda las **reglas de roles** y los flujos t√≠picos.

---

````markdown
# SIGCHI ‚Äì Backend API (FastAPI + PostgreSQL)

Este documento explica la API del backend de **SIGCHI ‚Äì Sistema de Registro, Asignaci√≥n de Citas e Historias Cl√≠nicas** para el equipo de frontend.

- Backend: **FastAPI**
- BD: **PostgreSQL**
- ORM: **SQLAlchemy**
- Validaci√≥n: **Pydantic v2**
- Auth: **OAuth2 password flow + JWT (Bearer token)**

> Nota: todas las rutas descritas aqu√≠ son JSON sobre HTTP, y requieren `Content-Type: application/json` salvo donde se indica lo contrario (login con `application/x-www-form-urlencoded`).

---

## 1. Arquitectura general (mental model para frontend)

### 1.1. Entidades principales

- **User**
  - Representa la cuenta de acceso al sistema.
  - Campos clave:
    - `id`
    - `email`
    - `first_name` (opcional)
    - `last_name` (opcional)
    - `is_active`
    - `role_id` ‚Üí referencia a **Role**
  - Cada `User` tiene **un √∫nico rol**.

- **Role**
  - Solo se manejan 3 roles:
    - `"admin"`
    - `"doctor"`
    - `"patient"`

- **Patient**
  - Perfil de paciente asociado 1:1 a un `User` cuyo rol es `"patient"`.
  - Campos:
    - `id`
    - `user_id` ‚Üí `User.id`
    - `document_type`, `document_number`
    - `phone`, `address`
    - `birth_date` (date)

- **Doctor**
  - Perfil de doctor asociado 1:1 a un `User` cuyo rol es `"doctor"`.
  - Campos:
    - `id`
    - `user_id` ‚Üí `User.id`
    - `specialty`

- **Appointment** (citas)
  - Relaciona un `Patient` y un `Doctor`.
  - Campos:
    - `id`
    - `patient_id` ‚Üí `Patient.id`
    - `doctor_id` ‚Üí `Doctor.id`
    - `scheduled_at` (datetime con zona)
    - `status` ‚Üí `"scheduled" | "completed" | "cancelled"` (de momento se usa `"scheduled"` y `"cancelled"`)
    - `reason` (motivo de consulta, opcional)
    - `notes` (notas internas, opcional)
    - `created_at`, `updated_at`

- **ClinicalHistory**
  - Registro de una atenci√≥n m√©dica.
  - Campos:
    - `id`
    - `patient_id` ‚Üí `Patient.id`
    - `doctor_id` ‚Üí `Doctor.id`
    - `appointment_id` ‚Üí `Appointment.id` (opcional)
    - `visit_date` (datetime)
    - `diagnosis` (texto)
    - `treatment` (texto)
    - `notes` (texto)
    - `created_at`, `updated_at`

---

## 2. Autenticaci√≥n y autorizaci√≥n

### 2.1. Login (obtener token)

**Endpoint**

- `POST /api/auth/token`
- Body (form-data, tipo `application/x-www-form-urlencoded`):

```x-www-form-urlencoded
username=<email_del_usuario>
password=<password>
````

**Respuesta**

```json
{
  "access_token": "<JWT>",
  "token_type": "bearer"
}
```

### 2.2. Uso del token

En todas las rutas protegidas:

```http
Authorization: Bearer <JWT>
```

El token contiene el `sub` con el `user.id`. En backend se resuelve a:

* `get_current_user` ‚Üí devuelve el `User` autenticado.
* Sobre ese `User` se mira el `Role` (`admin`, `doctor`, `patient`) para aplicar reglas.

### 2.3. Reglas de acceso por rol (resumen)

* **admin**

  * Puede crear usuarios de cualquier rol.
  * Puede crear perfiles `Doctor` y `Patient`.
  * Puede ver todas las citas e historias cl√≠nicas.
  * Puede modificar y cancelar cualquier cita.
  * Puede modificar y eliminar cualquier historia cl√≠nica.

* **doctor**

  * Puede ver **su propio perfil** de doctor (`GET /api/doctors/me`).
  * Solo ve:

    * citas donde `doctor_id` sea el suyo.
    * historias cl√≠nicas donde `doctor_id` sea el suyo.
  * Puede crear historias cl√≠nicas donde √©l sea el doctor.
  * Puede actualizar sus propias citas e historias (no las de otros doctores).

* **patient**

  * Puede ver **su propio perfil** de paciente (`GET /api/patients/me`).
  * Solo ve:

    * sus propias citas (como paciente).
    * sus propias historias cl√≠nicas.
  * Puede cancelar **sus propias citas**.
  * No puede crear ni editar historias cl√≠nicas.

---

## 3. Convenciones generales

* **Formato de fechas**:

  * `datetime`: cadenas en **ISO 8601**, por ejemplo:

    * `"2025-11-20T10:00:00Z"`
    * `"2025-11-20T10:00:00+00:00"`
  * `date`: `"YYYY-MM-DD"`, por ejemplo `"1995-05-10"`.

* **Errores habituales**:

  * `401 Unauthorized`: token ausente o inv√°lido.
  * `403 Forbidden`: el usuario no tiene permisos (rol).
  * `404 Not Found`: recurso no existe o no est√° autorizado para verlo (seg√∫n implementaci√≥n).
  * `422 Unprocessable Entity`: error de validaci√≥n Pydantic (ej: email mal formado).

* **Respuesta por defecto**:

  * El backend responde con el modelo JSON directamente (no hay wrapper tipo `{ "data": ..., "meta": ... }` por ahora).

---

## 4. Endpoints por m√≥dulo

### 4.1. Auth

#### POST `/api/auth/token`

* **Descripci√≥n**: login con email + password, devuelve JWT.
* **Body (x-www-form-urlencoded)**:

```text
username=<email>
password=<password>
```

* **Respuesta 200**:

```json
{
  "access_token": "<JWT>",
  "token_type": "bearer"
}
```

* **Errores**:

  * `401`: credenciales incorrectas.
  * `400`: usuario inactivo (si se llega a usar esa validaci√≥n).
  * `422`: body mal formado.

---

### 4.2. Users

#### POST `/api/users/` (admin only)

* **Descripci√≥n**: crea un nuevo usuario del sistema (cuenta base).

* **Auth**: requiere usuario con rol `admin`.

* **Body (JSON)**:

```json
{
  "email": "user@example.com",
  "password": "Password123!",
  "role_id": 1   // id del rol en la tabla roles (1=admin, 2=doctor, 3=patient, seg√∫n BD)
}
```

* **Respuesta 201** (ejemplo):

```json
{
  "id": 5,
  "email": "user@example.com",
  "is_active": true,
  "role_id": 2
  // puede incluir m√°s campos seg√∫n el schema configurado (first_name, last_name, etc.)
}
```

* **Errores**:

  * `400`: email ya registrado.
  * `400`: role_id inv√°lido.
  * `403`: si quien llama no es `admin`.
  * `422`: validaci√≥n de email, etc.

#### GET `/api/users/me`

* **Descripci√≥n**: devuelve el usuario autenticado.

* **Auth**: cualquier usuario logueado (`admin`, `doctor`, `patient`).

* **Respuesta 200** (ejemplo):

```json
{
  "id": 1,
  "email": "testuser@example.com",
  "is_active": true,
  "role_id": 1
  // etc.
}
```

---

### 4.3. Patients

#### POST `/api/patients/` (admin only)

* **Descripci√≥n**: crea un perfil de paciente asociado a un `User` con rol `"patient"`.

* **Auth**: `admin`.

* **Body (JSON)**:

```json
{
  "user_id": 3,
  "document_type": "CC",
  "document_number": "123456789",
  "phone": "3001234567",
  "address": "Calle 123 #45-67",
  "birth_date": "1995-05-10"
}
```

* **Respuesta 201**:

```json
{
  "id": 1,
  "user_id": 3,
  "document_type": "CC",
  "document_number": "123456789",
  "phone": "3001234567",
  "address": "Calle 123 #45-67",
  "birth_date": "1995-05-10"
}
```

* **Errores**:

  * `400`: user no existe.
  * `400`: user no tiene rol `"patient"`.
  * `400`: ya existe un perfil `Patient` para ese `user_id`.
  * `403`: si quien llama no es admin.

#### GET `/api/patients/me`

* **Descripci√≥n**: devuelve el perfil de paciente asociado al usuario autenticado (si es `patient`).

* **Auth**: rol `patient` (si es otro rol, el backend puede devolver 403 o 404 seg√∫n la l√≥gica).

* **Respuesta 200**:

```json
{
  "id": 1,
  "user_id": 3,
  "document_type": "CC",
  "document_number": "123456789",
  "phone": "3001234567",
  "address": "Calle 123 #45-67",
  "birth_date": "1995-05-10"
}
```

#### GET `/api/patients/` (opcional seg√∫n implem.)

* Puede existir un listado de pacientes para admin, con paginaci√≥n b√°sica (`skip`, `limit`).
  En caso de usarse, asumimos:

  * **Auth**: `admin`.
  * **Query params**:

    * `skip` (int, default 0)
    * `limit` (int, default 20)

---

### 4.4. Doctors

#### POST `/api/doctors/` (admin only)

* **Descripci√≥n**: crea el perfil de doctor asociado a un `User` con rol `"doctor"`.

* **Auth**: `admin`.

* **Body (JSON)**:

```json
{
  "user_id": 2,
  "specialty": "Cardiolog√≠a"
}
```

* **Respuesta 201**:

```json
{
  "id": 1,
  "user_id": 2,
  "specialty": "Cardiolog√≠a"
}
```

* **Errores**:

  * `400`: user no existe.
  * `400`: user no tiene rol `"doctor"`.
  * `400`: ya existe un perfil `Doctor` para ese `user_id`.

#### GET `/api/doctors/me` (doctor only)

* **Descripci√≥n**: devuelve el perfil de doctor del usuario autenticado.

* **Auth**: rol `doctor`.

* **Respuesta 200**:

```json
{
  "id": 1,
  "user_id": 2,
  "specialty": "Cardiolog√≠a"
}
```

#### GET `/api/doctors/`

* **Descripci√≥n**: lista doctores, con paginaci√≥n.

* **Auth**: actualmente restringido a `admin` (posible extensi√≥n a `doctor`/`patient` si se define as√≠).

* **Query params**:

  * `skip` (int, default 0)
  * `limit` (int, default 20)

* **Respuesta 200**:

```json
[
  {
    "id": 1,
    "user_id": 2,
    "specialty": "Cardiolog√≠a"
  },
  {
    "id": 2,
    "user_id": 4,
    "specialty": "Medicina General"
  }
]
```

#### GET `/api/doctors/{doctor_id}`

* **Descripci√≥n**: devuelve un doctor espec√≠fico.
* **Auth**: cualquier usuario autenticado (se puede usar como cat√°logo para agendar citas).

#### PUT `/api/doctors/{doctor_id}`

* **Descripci√≥n**: actualiza datos del doctor.

* **Auth**:

  * `admin`: puede actualizar cualquier doctor.
  * `doctor`: solo su propio perfil.

* **Body (JSON)**:

```json
{
  "specialty": "Medicina Interna"
}
```

#### DELETE `/api/doctors/{doctor_id}`

* **Descripci√≥n**: elimina un doctor.
* **Auth**: solo `admin`.

---

### 4.5. Appointments (Citas)

#### POST `/api/appointments/`

* **Descripci√≥n**: crea una cita.

* **Auth**:

  * `admin`: puede crear citas para cualquier `patient_id` y `doctor_id` v√°lidos.
  * `doctor`: solo puede crear citas donde `doctor_id` sea su propio perfil.
  * `patient`: solo puede crear citas donde `patient_id` sea su propio perfil.

* **Body (JSON)**:

```json
{
  "patient_id": 1,
  "doctor_id": 1,
  "scheduled_at": "2025-11-20T10:00:00Z",
  "reason": "Consulta general",
  "notes": "Cita de prueba"
}
```

* **Respuesta 201**:

```json
{
  "id": 1,
  "patient_id": 1,
  "doctor_id": 1,
  "scheduled_at": "2025-11-20T10:00:00Z",
  "reason": "Consulta general",
  "notes": "Cita de prueba",
  "status": "scheduled",
  "created_at": "2025-11-18T12:00:00Z",
  "updated_at": "2025-11-18T12:00:00Z"
}
```

#### GET `/api/appointments/`

* **Descripci√≥n**: lista citas seg√∫n el rol.

* **Auth**:

  * `admin`: ve todas las citas.
  * `doctor`: ve solo citas donde √©l es el doctor.
  * `patient`: ve solo citas donde √©l es el paciente.

* **Query params**:

  * `skip` (int, default 0)
  * `limit` (int, default 20)

* **Respuesta 200**: lista de `AppointmentResponse`.

#### GET `/api/appointments/{appointment_id}`

* **Descripci√≥n**: devuelve una cita espec√≠fica.
* **Auth**:

  * `admin`: cualquier cita.
  * `doctor`: solo si es su cita.
  * `patient`: solo si es su cita.

#### PUT `/api/appointments/{appointment_id}`

* **Descripci√≥n**: actualiza una cita.

* **Auth**:

  * `admin`: cualquier cita.
  * `doctor`: solo sus propias citas.
  * `patient`: en principio no actualiza (solo cancela).

* **Body (JSON)** (todos opcionales):

```json
{
  "scheduled_at": "2025-11-20T11:00:00Z",
  "reason": "Cambio de horario",
  "notes": "Paciente solicit√≥ cambio",
  "status": "scheduled"
}
```

#### POST `/api/appointments/{appointment_id}/cancel`

* **Descripci√≥n**: cancela una cita (`status` pasa a `"cancelled"`).

* **Auth**:

  * `admin`: cualquier cita.
  * `doctor`: solo citas donde es el doctor.
  * `patient`: solo citas donde es el paciente.

* **Respuesta 200**: cita con `status: "cancelled"`.

---

### 4.6. Clinical Histories (Historias cl√≠nicas)

#### POST `/api/histories/`

* **Descripci√≥n**: crea una historia cl√≠nica.

* **Auth**:

  * `admin`: puede crear cualquier historia v√°lida.
  * `doctor`: solo si `doctor_id` coincide con su perfil.
  * `patient`: **no** puede crear historias.

* **Body (JSON)**:

```json
{
  "patient_id": 1,
  "doctor_id": 1,
  "appointment_id": 1,     // opcional
  "visit_date": "2025-11-20T10:30:00Z",
  "diagnosis": "Paciente sano",
  "treatment": "Control anual",
  "notes": "Historia creada en la cita de prueba"
}
```

* **Respuesta 201**: `ClinicalHistoryResponse`.

#### GET `/api/histories/`

* **Descripci√≥n**: lista historias cl√≠nicas seg√∫n el rol.

* **Auth**:

  * `admin`: todas.
  * `doctor`: solo historias donde √©l es el doctor.
  * `patient`: solo historias donde √©l es el paciente.

* **Query params**:

  * `skip` (int, default 0)
  * `limit` (int, default 20 o 50 seg√∫n config).

#### GET `/api/histories/{history_id}`

* **Descripci√≥n**: devuelve una historia espec√≠fica.
* **Auth**:

  * `admin`: cualquier historia.
  * `doctor`: solo si es el doctor en esa historia.
  * `patient`: solo si es el paciente en esa historia.

#### GET `/api/histories/patient/{patient_id}`

* **Descripci√≥n**: lista historias de un paciente concreto.
* **Auth**:

  * `admin`: cualquier paciente.
  * `doctor`: solo si todas las historias son de atenciones hechas por √©l.
  * `patient`: solo si `patient_id` coincide con su propio perfil.

#### PUT `/api/histories/{history_id}`

* **Descripci√≥n**: actualiza una historia.

* **Auth**:

  * `admin`: cualquier historia.
  * `doctor`: solo si es el doctor de esa historia.
  * `patient`: no puede actualizar.

* **Body (JSON)** (todos opcionales):

```json
{
  "visit_date": "2025-11-20T11:00:00Z",
  "diagnosis": "Actualizaci√≥n del diagn√≥stico",
  "treatment": "Nuevo tratamiento",
  "notes": "Notas actualizadas"
}
```

#### DELETE `/api/histories/{history_id}`

* **Descripci√≥n**: elimina una historia cl√≠nica.
* **Auth**: solo `admin`.

---

## 5. Flujos t√≠picos pensados para frontend

### 5.1. Flujo admin para crear doctor y paciente

1. **Login** admin ‚Üí `POST /api/auth/token`.
2. **Crear user doctor** ‚Üí `POST /api/users/`.
3. **Crear perfil doctor** ‚Üí `POST /api/doctors/`.
4. **Crear user patient** ‚Üí `POST /api/users/`.
5. **Crear perfil patient** ‚Üí `POST /api/patients/`.

### 5.2. Flujo doctor

* Login ‚Üí `/api/auth/token`.
* Ver su perfil ‚Üí `GET /api/doctors/me`.
* Ver sus citas ‚Üí `GET /api/appointments/`.
* Crear historias cl√≠nicas ‚Üí `POST /api/histories/`.

### 5.3. Flujo patient

* Login ‚Üí `/api/auth/token`.
* Ver su perfil ‚Üí `GET /api/patients/me`.
* Ver sus citas ‚Üí `GET /api/appointments/`.
* Cancelar cita ‚Üí `POST /api/appointments/{id}/cancel`.
* Ver sus historias ‚Üí `GET /api/histories/`.

---

## 6. Notas para el frontend

* **Token storage**: el frontend debe almacenar el `access_token` (ej. en memoria, localStorage, etc.) y enviarlo en cada petici√≥n protegida como `Authorization: Bearer <token>`.
* **Control de UI por rol**:

  * El frontend puede usar:

    * `/api/users/me` ‚Üí para saber qu√© rol tiene el usuario actual.
    * Seg√∫n `role_name` (`admin`, `doctor`, `patient`), habilitar/deshabilitar vistas:

      * AdminPanel, AgendaDoctor, AgendaPaciente, etc.
* **Manejo de fechas**:

  * En formularios de citas e historias, usar siempre formato ISO 8601 con zona horaria.
  * Para fechas de nacimiento (`birth_date`), formato simple `YYYY-MM-DD`.

