<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SIGCHI – Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body {
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, #e8f1ff, #f7fbff 40%, #e8f1ff 80%);
    }
    .card-login {
      max-width: 440px;
      margin: 5vh auto;
      box-shadow: 0 12px 32px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
<div class="card card-login">
  <div class="card-body">
    <h1 class="h4 fw-bold mb-1 text-center">SIGCHI</h1>
    <p class="text-secondary text-center mb-4">Ingreso a la plataforma de citas</p>

    <form id="login-form" class="mb-2">
      <div class="mb-2">
        <label class="form-label">Correo</label>
        <input type="email" name="username" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Contraseña</label>
        <input type="password" name="password" class="form-control" required>
      </div>
      <button class="btn btn-primary w-100" type="submit">Ingresar</button>
    </form>
    <div id="alert-slot"></div>
  </div>
</div>
<script>
  const alertSlot = document.getElementById("alert-slot");

  function showAlert(msg, type = "danger") {
    alertSlot.innerHTML = `<div class="alert alert-${type} mb-0">${msg}</div>`;
  }

  function getBaseUrl() {
    return window.location.origin.replace(/\/$/, "");
  }

  async function apiLogin(formData) {
    const body = new URLSearchParams(formData);
    const res = await fetch(getBaseUrl() + "/api/auth/token", {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body
    });
    if (!res.ok) {
      throw new Error("Credenciales inválidas");
    }
    return res.json();
  }

  async function fetchMe(token) {
    const res = await fetch(getBaseUrl() + "/api/users/me", {
      headers: {Authorization: "Bearer " + token}
    });
    if (!res.ok) {
      throw new Error("No se pudo obtener /me");
    }
    return res.json();
  }

  document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    alertSlot.innerHTML = "";
    const form = new FormData(e.target);
    try {
      const login = await apiLogin(form);
      const token = login.access_token;
      const me = await fetchMe(token);
      const role = me.role_name || ({1:"admin",2:"doctor",3:"patient"}[me.role_id]);
      localStorage.setItem("sigchi_token", token);
      localStorage.setItem("sigchi_role", role || "");
      document.cookie = `access_token=${token}; path=/; SameSite=Lax`;
      document.cookie = `role_name=${role}; path=/; SameSite=Lax`;
      const target = role === "admin" ? "/admin" : role === "doctor" ? "/doctor" : "/patient";
      window.location.href = target;
    } catch (err) {
      const msg = err.message || "Error al iniciar sesión";
      showAlert(msg);
      alert(msg);
    }
  });

</script>
</body>
</html>
